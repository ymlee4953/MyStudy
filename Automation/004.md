# **001 - Ansible Setup**

## **OS update**
- update CentOS to latest
  d

## **Environment**
- d
  - d

## **Steps** 

### **Step 1: OS update**
-  update CentOS to latest
  - d
    - f

         
    - Done

          mkdir -p ~/ansible-playbooks/LB

          cat <<EOF> ~/ansible-playbooks/LB/install_haproxy.yml
          # install_haproxy.yml
          ---
          - hosts: lb*
            become: true
            tasks:
              - name: install base package 
                command: yum install -y gcc pcre-static pcre-devel
                command: yum install -y wget
                command: yum install -y make
                command: yum install -y openssl-devel
          - hosts: BASTION-0
            become: true
            tasks:
              - name: Fetch the etcdadm file from the Bastion_0
                fetch: 
                  src: ~/haproxy/{{ item }}
                  dest: ~/files/
                with_items:
                - haproxy-1.7.8.tar.gz
          - hosts: lb*
            become: true
            tasks: 
              - name: Copy the file to the haproxy
                copy: 
                  src: ~/files/BASTION-0/root/haproxy/haproxy-1.7.8.tar.gz
                  dest: /opt/
          - hosts: lb*
            become: true
            tasks: 
              - name: install HA proxy
                command: cd /opt
                command: tar xzvf haproxy-1.7.8.tar.gz

                command: cd /opt/haproxy-1.7.8
                command: make TARGET=linux2628 USE_OPENSSL=1
                command: make install

                command: mkdir -p /etc/haproxy
                command: mkdir -p /var/lib/haproxy 
                command: touch /var/lib/haproxy/stats
                command: ln -s /usr/local/sbin/haproxy /usr/sbin/haproxy

                command: cp /opt/haproxy-1.7.8/examples/haproxy.init /etc/init.d/haproxy
                command: chmod 755 /etc/init.d/haproxy
                  
                command: systemctl daemon-reload
                command: systemctl enable haproxy

                command: useradd -r haproxy
          EOF

          cat ~/ansible-playbooks/LB/install_haproxy.yml

          ansible-playbook -i k8s-cluster-hosts ~/ansible-playbooks/LB/install_haproxy.yml

    - prepare haproxy.cfg at the ansible server

          mkdir -p ~/configurations/LB/etc/haproxy

          cat <<EOF > ~/configurations/LB/etc/haproxy/haproxy.cfg 
          global
                log /dev/log local0
                log /dev/log local1 notice
                chroot /var/lib/haproxy
                stats timeout 30s
                user haproxy
                group haproxy
                daemon
            
          defaults
                maxconn 20000
                mode    tcp
                option  dontlognull
                timeout http-request 10s
                timeout queue        1m
                timeout connect      10s
                timeout client       86400s
                timeout server       86400s
                timeout tunnel       86400s
          EOF

          cat ~/configurations/LB/etc/haproxy/haproxy.cfg 

          mkdir -p ~/configurations/LB-1/etc/haproxy

          cp ~/configurations/LB/etc/haproxy/haproxy.cfg ~/configuration/LB-1/etc/haproxy/haproxy.cfg

          cat <<EOF>> ~/configurations/LB-1/etc/haproxy/haproxy.cfg

          #---------------------------------------------------------------------
          # For a High Available kubenetes master node cluster 
          #---------------------------------------------------------------------

          frontend kubernetes
              bind ${LB_1}:6443
              mode tcp
              option tcplog
              default_backend kubernetes-backend

          backend kubernetes-backend
              mode tcp
              option tcp-check
              balance roundrobin
              server master-1 ${MASTER_1}:6443 check fall 3 rise 2
              server master-2 ${MASTER_2}:6443 check fall 3 rise 2
              server master-3 ${MASTER_3}:6443 check fall 3 rise 2
          EOF

          cat ~/configurations/LB-1/etc/haproxy/haproxy.cfg





2. init 
  -  
    - 
      -  

          cat <<EOF> ~/ansible-playbooks/LB/playbookfile.yml
          # playbookfile.yml
          ---
          - hosts: ETCD-1
            become: true
            tasks:
              - name: initialize etcd cluster
                command: ~/etcdadm init
          EOF

          cat ~/ansible-playbooks/LB/playbookfile.yml

          ansible-playbook -i k8s-cluster-hosts ~/ansible-playbooks/LB/playbookfile.yml
2. init 
  -  
    - 
      -  

          cat <<EOF> ~/ansible-playbooks/LB/start_haproxy.yml
          # start_haproxy.yml
          ---
          - hosts: LB-1
            become: true
            tasks:
              - name: copy haproxy config file
                copy:
                  src: ~/configuration/LB-1/etc/haproxy/haproxy.cfg
                  dest: /etc/haproxy/haproxy.cfg
          # - hosts: LB-1
          #  become: true
          #  tasks:
          #    - name: start haproxy
          #      command: systemctl daemon-reload
          #      command: systemctl start haproxy
          #      command: systemctl enable haproxy
          #      command: systemctl status haproxy
          EOF

          cat ~/ansible-playbooks/LB/start_haproxy.yml

          ansible-playbook -i k8s-cluster-hosts ~/ansible-playbooks/LB/start_haproxy.yml

2. init 
  -  
    - 
      -  

          cat <<EOF> ~/ansible-playbooks/dirdir/playbookfile.yml
          # playbookfile.yml
          ---
          - hosts: ETCD-1
            become: true
            tasks:
              - name: initialize etcd cluster
                command: ~/etcdadm init
          EOF

          cat ~/ansible-playbooks/LB/playbookfile.yml

          ansible-playbook -i k8s-cluster-hosts ~/ansible-playbooks/LB/playbookfile.yml

2. init 
  -  
    - 
      -  

          cat <<EOF> ~/ansible-playbooks/dirdir/playbookfile.yml
          # playbookfile.yml
          ---
          - hosts: ETCD-1
            become: true
            tasks:
              - name: initialize etcd cluster
                command: ~/etcdadm init
          EOF

          cat ~/ansible-playbooks/LB/playbookfile.yml

          ansible-playbook -i k8s-cluster-hosts ~/ansible-playbooks/LB/playbookfile.yml
