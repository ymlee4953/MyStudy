# **001 - Ansible Setup**

## **OS update**
- update CentOS to latest
  d

## **Environment**
- d
  - d

## **Steps** 

### **Step 1: OS update**
-  update CentOS to latest
  - d
    - f

         
    - Done

          mkdir -p ~/files

          cat <<EOF> ~/ansible-playbooks/LB/install_haproxy2.yml
          ---
          - hosts: lb*
            become: true
            tasks:
              - name: install base package
                command: yum install -y gcc pcre-static pcre-devel
                command: yum install -y wget
                command: yum install -y make
                command: yum install -y openssl-devel
          ---
          - hosts: lb*:BASTION-0
            become: true
            tasks:
              - name: Fetch the file form the Bastion
                fetch:
                  src: ~/haproxy/haproxy-1.7.8.tar.gz
                  dest: ~/ansible-playbooks/BASTION-0/files/haproxy-1.7.8.tar.gz
                when: "{{ inventory_hostname == 'BASTION-0' }}"
              - name: Copy the file to the haproxy
                copy:  ~/ansible-playbooks/BASTION-0/files/haproxy-1.7.8.tar.gz
                dest: ~/opt/haproxy/haproxy-1.7.8.tar.gz
                when: inventory_hostname is in group lb* 
          EOF

          cat ~/ansible-playbooks/LB/install_haproxy2.yml

          ansible-playbooks/LB/install_haproxy2.yml






- 








          cat <<EOF> ~/ansible-playbooks/etcd/copy_etcdadm.yml
          # copy_etcdadm.yml
          ---
          - hosts: BASTION-0
            become: true
            tasks:
              - name: Fetch the etcdadm file from the Bastion_0
                fetch: 
                  src: /root/etcdadm/{{ item }}
                  dest: ~/files/
                with_items:
                - etcdadm
                - etcd-v3.4.9-linux-amd64.tar.gz  
          - hosts: etcd
            become: true
            tasks:           
              - name: Copy the file to etcd
                copy:
                  src:  ~/files/BASTION-0/root/etcdadm/etcdadm
                  dest: ~/
          - hosts: etcd
            become: true
            tasks:           
              - name: chmod of etcdadm
                command: chmod 755 ~/etcdadm
          - hosts: etcd
            become: true
            tasks:           
              - name: Copy the tar file to etcd v3.4.9
                copy:
                  src:  ~/files/BASTION-0/root/etcdadm/etcd-v3.4.9-linux-amd64.tar.gz
                  dest: /var/cache/etcdadm/etcd/v3.4.9/
          EOF

          cat ~/ansible-playbooks/etcd/copy_etcdadm.yml

          ansible-playbook -i k8s-cluster-hosts ~/ansible-playbooks/etcd/copy_etcdadm.yml

    - execute copy

          ansible-playbook -i k8s-cluster-hosts ~/ansible-playbooks/etcd/copy_etcdadm.yml
         


2. init 
  -  
    - 
      -  

          cat <<EOF> ~/ansible-playbooks/etcd/etcdadm_init.yml
          # etcdadm_init.yml
          ---
          - hosts: ETCD-1
            become: true
            tasks:
              - name: initialize etcd cluster
                command: ~/etcdadm init
          EOF

          cat ~/ansible-playbooks/etcd/etcdadm_init.yml

          ansible-playbook -i k8s-cluster-hosts ~/ansible-playbooks/etcd/etcdadm_init.yml

3. copy cert

    -
          mkdir -p ~/files

          cat <<EOF> ~/ansible-playbooks/etcd/copy_etcd_cert.yml
          # copy_etcd_cert_.yml
          ---
          - hosts: ETCD-1
            become: true
            tasks:
              - name: Fetch the etcd-cert files from the ETCD_1
                fetch: 
                  src: /etc/etcd/pki/{{ item }}
                  dest: ~/files/
                with_items:
                - ca.crt
                - ca.key  
          - hosts: ETCD-2:ETCD-3
            become: true
            tasks:           
              - name: Copy the file to etcd2 etcd3
                copy:
                  src:  ~/files/ETCD-1/etc/etcd/pki/{{ item }}
                  dest: /etc/etcd/pki/
                with_items:
                - ca.crt
                - ca.key  
          EOF

          cat ~/ansible-playbooks/etcd/copy_etcd_cert.yml

          ansible-playbook -i k8s-cluster-hosts ~/ansible-playbooks/etcd/copy_etcd_cert.yml

    - execute copy

          ansible-playbook -i k8s-cluster-hosts ~/ansible-playbooks/etcd/copy_etcdadm.yml
         


3. join cert

    -
          mkdir -p ~/files

          cat <<EOF> ~/ansible-playbooks/etcd/etcdadm_join.yml
          # etcdadm_join.yml
          ---
          - hosts: ETCD-2:ETCD-3
            become: true
            tasks:
              - name: join to etcd cluster
                command:  ~/etcdadm join https://${ETCD_1}:2379
          EOF

          cat ~/ansible-playbooks/etcd/etcdadm_join.yml

          ansible-playbook -i k8s-cluster-hosts ~/ansible-playbooks/etcd/etcdadm_join.yml

          - hosts: ETCD-1
            become: true
            tasks:
              - name: get IP of ETCD-1


          #      command: ~/etcdadm join https://{{ hostvars[inventory_hostname == 'ETCD-1'}['ansible_default_ipv4.address'] }}:2379
          #      command:  ~/etcdadm join https://{{ hostvars[ ETCD-1 ]['ansible_default_ipv4']['address'] }}:2379
                command:  ~/etcdadm join https
                ://{{ etcd[0] }}:2379
              


          #      command: ~/etcdadm join https://{{ hostvars[inventory_hostname == 'ETCD-1'}['ansible_default_ipv4.address'] }}:2379
          #      command:  ~/etcdadm join https://{{ hostvars[ ETCD-1 ]['ansible_default_ipv4']['address'] }}:2379
                command:  ~/etcdadm join https://{{ hostvars[ 'ETCD-1' ].ansible_default_ipv4.address }}:2379


                debug:
                  msg:  echo hostvars[ ETCD-1 ]['ansible_default_ipv4']['address']

                command:  ~/etcdadm join https://{{ hostvars[ ETCD-1 ]['ansible_default_ipv4']['address'] }}:2379

                command: 
          #        ~/etcdadm join https://{{ inventory_hostname == ETCD-1 }}:2379
          #        ~/etcdadm join https://{{ hostvars[inventory_hostname == ETCD-1]['ansible_default_ipv4']['address'] }}:2379

                  ~/etcdadm join https://10.168.180.209:2379

                
          - hosts: ETCD-2:ETCD-3
            become: true
            tasks:           
              - name: Copy the file to etcd2 etcd3
                copy:
                  src:  ~/files/ETCD-1/etc/etcd/pki/ca.*
                  dest: /etc/etcd/pki/
          - hosts: etcd
            become: true
            tasks:           
              - name: chmod of etcdadm
                command: chmod 755 ~/etcdadm
          - hosts: etcd
            become: true
            tasks:           
              - name: Copy the tar file to etcd v3.4.9
                copy:
                  src:  ~/files/BASTION-0/root/etcdadm/etcd-v3.4.9-linux-amd64.tar.gz
                  dest: /var/cache/etcdadm/etcd/v3.4.9/

    


